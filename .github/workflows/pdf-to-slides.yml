name: PDF to Slides Converter

on:
  schedule:
    - cron: '7 * * * *'  # ë§¤ì‹œ 7ë¶„ë§ˆë‹¤ (1ì‹œê°„ í´ë§)
  workflow_dispatch:       # GitHub ì›¹ UIì—ì„œ ìˆ˜ë™ ì‹¤í–‰

permissions:
  contents: write          # ì»¤ë°‹/í‘¸ì‹œì— í•„ìš”
  pages: write             # Pages ë°°í¬ì— í•„ìš”
  id-token: write          # Pages ë°°í¬ ì¸ì¦ì— í•„ìš”

concurrency:
  group: "pages"
  cancel-in-progress: true

jobs:
  convert:
    runs-on: ubuntu-latest
    outputs:
      changed: ${{ steps.dropbox.outputs.changed }}
      pdf_name: ${{ steps.dropbox.outputs.pdf_name }}
      total_pages: ${{ steps.meta.outputs.total_pages }}

    steps:
      # --- ì €ì¥ì†Œ ì²´í¬ì•„ì›ƒ ---
      - name: Checkout repository
        uses: actions/checkout@v4

      # --- Dropbox Access Token ê°±ì‹  (Refresh Tokenìœ¼ë¡œ ë§¤ ì‹¤í–‰ ì‹œ ë°œê¸‰) ---
      - name: Get Dropbox Access Token
        run: |
          RESPONSE=$(curl -s -X POST https://api.dropboxapi.com/oauth2/token \
            -d grant_type=refresh_token \
            -d refresh_token=${{ secrets.DROPBOX_REFRESH_TOKEN }} \
            -d client_id=${{ secrets.DROPBOX_APP_KEY }} \
            -d client_secret=${{ secrets.DROPBOX_APP_SECRET }})
          ACCESS_TOKEN=$(echo "$RESPONSE" | python3 -c "import json,sys; print(json.load(sys.stdin)['access_token'])")
          echo "DROPBOX_ACCESS_TOKEN=$ACCESS_TOKEN" >> $GITHUB_ENV

      # --- Dropboxì—ì„œ PDF í™•ì¸ ë° ë‹¤ìš´ë¡œë“œ ---
      - name: Check Dropbox for PDF
        id: dropbox
        run: |
          echo "=== Dropbox í´ë” í™•ì¸ ==="

          # App folder ë£¨íŠ¸ì˜ íŒŒì¼ ëª©ë¡ ì¡°íšŒ
          RESPONSE=$(curl -s -X POST \
            https://api.dropboxapi.com/2/files/list_folder \
            -H "Authorization: Bearer $DROPBOX_ACCESS_TOKEN" \
            -H "Content-Type: application/json" \
            -d '{"path": "/Share/2026/ë²„ì¶”ì–¼ ëŒ€í•™êµ PDF ì—…ë¡œë“œ í´ë”", "recursive": false}')

          # PDF íŒŒì¼ í•„í„°ë§ (1ê°œë§Œ í—ˆìš©)
          PDF_RESULT=$(echo "$RESPONSE" | python3 -c "
          import json, sys
          data = json.load(sys.stdin)
          entries = data.get('entries', [])
          pdfs = [e for e in entries if e.get('name', '').lower().endswith('.pdf')]
          if len(pdfs) == 0:
              print('NONE')
          elif len(pdfs) > 1:
              names = ', '.join(e['name'] for e in pdfs)
              print(f'ERROR:{names}')
          else:
              print(json.dumps(pdfs[0]))
          ")

          if [ "$PDF_RESULT" = "NONE" ]; then
            echo "PDF íŒŒì¼ ì—†ìŒ. ì¢…ë£Œ."
            echo "found=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          if [[ "$PDF_RESULT" == ERROR:* ]]; then
            echo "::error::í´ë”ì— PDFê°€ ì—¬ëŸ¬ ê°œ ìˆìŠµë‹ˆë‹¤: ${PDF_RESULT#ERROR:}"
            echo "::error::í´ë”ì— PDFë¥¼ 1ê°œë§Œ ìœ ì§€í•´ì£¼ì„¸ìš”."
            exit 1
          fi

          PDF_NAME=$(echo "$PDF_RESULT" | python3 -c "import json,sys; print(json.load(sys.stdin)['name'])")
          PDF_PATH=$(echo "$PDF_RESULT" | python3 -c "import json,sys; print(json.load(sys.stdin)['path_lower'])")
          PDF_HASH=$(echo "$PDF_RESULT" | python3 -c "import json,sys; print(json.load(sys.stdin).get('content_hash',''))")

          echo "ë°œê²¬: $PDF_NAME (hash: $PDF_HASH)"
          echo "found=true" >> $GITHUB_OUTPUT
          echo "pdf_name=$PDF_NAME" >> $GITHUB_OUTPUT
          echo "pdf_path=$PDF_PATH" >> $GITHUB_OUTPUT
          echo "pdf_hash=$PDF_HASH" >> $GITHUB_OUTPUT

          # ì´ì „ í•´ì‹œì™€ ë¹„êµ (ë³€ê²½ ì—†ìœ¼ë©´ ìŠ¤í‚µ)
          if [ -f ".last_pdf_hash" ]; then
            LAST_HASH=$(cat .last_pdf_hash)
            if [ "$PDF_HASH" = "$LAST_HASH" ]; then
              echo "PDF ë³€ê²½ ì—†ìŒ (hash ë™ì¼). ìŠ¤í‚µ."
              echo "changed=false" >> $GITHUB_OUTPUT
              exit 0
            fi
          fi
          echo "changed=true" >> $GITHUB_OUTPUT

          # PDF ë‹¤ìš´ë¡œë“œ
          echo "=== PDF ë‹¤ìš´ë¡œë“œ ==="
          curl -s -X POST \
            https://content.dropboxapi.com/2/files/download \
            -H "Authorization: Bearer $DROPBOX_ACCESS_TOKEN" \
            -H "Dropbox-API-Arg: {\"path\": \"$PDF_PATH\"}" \
            -o "input.pdf"

          ls -lh input.pdf

      # --- ë³€ê²½ ì—†ìœ¼ë©´ ì´í›„ ë‹¨ê³„ ìŠ¤í‚µ ---
      - name: Skip if no changes
        if: steps.dropbox.outputs.found != 'true' || steps.dropbox.outputs.changed != 'true'
        run: echo "ë³€ê²½ ì—†ìŒ. ì›Œí¬í”Œë¡œìš° ì¢…ë£Œ."

      # --- Python í™˜ê²½ ì„¤ì • ---
      - name: Setup Python
        if: steps.dropbox.outputs.changed == 'true'
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      # --- ì˜ì¡´ì„± ì„¤ì¹˜ ---
      - name: Install dependencies
        if: steps.dropbox.outputs.changed == 'true'
        run: |
          sudo apt-get update && sudo apt-get install -y poppler-utils
          pip install pdf2image Pillow

      # --- PDF â†’ ì´ë¯¸ì§€ ë³€í™˜ ---
      - name: Convert PDF to slides
        if: steps.dropbox.outputs.changed == 'true'
        run: python scripts/convert_pdf.py input.pdf "${{ steps.dropbox.outputs.pdf_name }}"

      # --- meta.jsonì—ì„œ ì´ í˜ì´ì§€ ìˆ˜ ì¶”ì¶œ ---
      - name: Read total pages from meta.json
        id: meta
        if: steps.dropbox.outputs.changed == 'true'
        run: |
          TOTAL=$(python3 -c "import json; print(json.load(open('Web/meta.json'))['total_pages'])")
          echo "total_pages=$TOTAL" >> $GITHUB_OUTPUT

      # --- í•´ì‹œ íŒŒì¼ ì €ì¥ (ë‹¤ìŒ ì‹¤í–‰ ì‹œ ë¹„êµìš©) ---
      - name: Save PDF hash
        if: steps.dropbox.outputs.changed == 'true'
        run: echo "${{ steps.dropbox.outputs.pdf_hash }}" > .last_pdf_hash

      # --- Git ì»¤ë°‹ & í‘¸ì‹œ ---
      - name: Commit and push
        if: steps.dropbox.outputs.changed == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add Web/slides/ Web/meta.json .last_pdf_hash
          git commit -m "slides: ${{ steps.dropbox.outputs.pdf_name }} ë³€í™˜ ë°˜ì˜"
          git push

  # --- ë³€í™˜ ì™„ë£Œ í›„ GitHub Pages ì§ì ‘ ë°°í¬ ---
  deploy:
    needs: convert
    if: needs.convert.outputs.changed == 'true'
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: main  # ë°©ê¸ˆ í‘¸ì‹œëœ ìµœì‹  ì»¤ë°‹ì„ ê°€ì ¸ì˜´

      - name: Setup Pages
        uses: actions/configure-pages@v5

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: './Web'

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

      # --- Discord ë°°í¬ ì•Œë¦¼ (ì„±ê³µ/ì‹¤íŒ¨ ë¬´ê´€í•˜ê²Œ í•­ìƒ ì „ì†¡) ---
      - name: Notify Discord
        if: always()
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
          PAGE_URL: ${{ steps.deployment.outputs.page_url }}
          PDF_NAME: ${{ needs.convert.outputs.pdf_name }}
          TOTAL_PAGES: ${{ needs.convert.outputs.total_pages }}
          DEPLOY_STATUS: ${{ job.status }}
          RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        run: |
                python3 - <<'PYEOF'
                import json, os, sys, urllib.request, urllib.error          
                status      = os.environ.get('DEPLOY_STATUS', 'unknown')
                pdf_name    = os.environ.get('PDF_NAME', '(ì•Œ ìˆ˜ ì—†ìŒ)')
                total_pages = os.environ.get('TOTAL_PAGES', '?')
                page_url    = os.environ.get('PAGE_URL', '')
                run_url     = os.environ.get('RUN_URL', '')
                webhook     = os.environ.get('DISCORD_WEBHOOK_URL', '')
                repo        = os.environ.get('GITHUB_REPOSITORY', '')
                
                icon  = 'âœ…' if status == 'success' else 'âŒ'
                color = 0x57F287 if status == 'success' else 0xED4245  # green / red
                
                fields = [
                    {'name': 'ğŸ“„ í˜ì´ì§€ ìˆ˜',  'value': f'{total_pages}ì¥', 'inline': True},
                    {'name': 'ğŸ“Š ë°°í¬ ìƒíƒœ', 'value': status,              'inline': True},
                ]
                if run_url:
                    fields.append({'name': 'ğŸ”— ì‹¤í–‰ ë¡œê·¸', 'value': f'[Actions ì—´ê¸°]({run_url})', 'inline': False})
                
                embed = {
                    'title':       f'{icon} SoopUniv ìŠ¬ë¼ì´ë“œ ë°°í¬',
                    'description': f'**{pdf_name}** ë³€í™˜ ì™„ë£Œ',
                    'color':       color,
                    'fields':      fields,
                    'footer':      {'text': repo},
                }
                if page_url:
                    embed['url']   = page_url
                    embed['image'] = {'url': page_url.rstrip('/') + '/slides/slide_001.jpg'}
                
                payload = json.dumps({'embeds': [embed]}).encode()
                req = urllib.request.Request(webhook, data=payload,
                                       headers={
                                           'Content-Type': 'application/json',
                                           'User-Agent': 'DiscordBot (https://discord.com, 1)',
                                             })
                try:
                    with urllib.request.urlopen(req) as r:
                        print(f'Discord ì•Œë¦¼ ì „ì†¡ ì™„ë£Œ ({r.status})')
                except urllib.error.HTTPError as e:
                    print(f'Discord ì „ì†¡ ì‹¤íŒ¨: {e.code} â€” {e.read().decode()}', file=sys.stderr)
                    sys.exit(1)
                PYEOF
